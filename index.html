<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº’å‹•å¼èª²ç¨‹è¡Œäº‹æ›†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        .month-container {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .day-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .day-cell {
            position: relative;
            width: 100%;
            padding-bottom: 100%; /* Aspect ratio 1:1 */
        }
        .day-content {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            color: #4b5563;
        }
        .day-header {
            text-align: center;
            font-weight: 500;
            color: #6b7280;
            padding-bottom: 0.5rem;
            font-size: 0.75rem;
        }
        .class-day {
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .class-day:hover, .day-selected {
            transform: scale(1.1);
            z-index: 5;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            border: 2px solid #3b82f6;
        }
        .leave-day {
            background-color: #fef9c3 !important;
            color: #713f12 !important;
            border: 2px dashed #facc15;
        }
        .leave-day .day-number {
            text-decoration: none;
        }
        .past-day {
            opacity: 0.6;
        }
        .past-day .day-number {
            text-decoration: line-through;
        }
        .tooltip {
            position: absolute;
            visibility: hidden;
            background-color: #1f2937;
            color: #ffffff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            z-index: 20;
            bottom: 105%;
            left: 50%;
            transform: translateX(-50%);
            white-space: normal;
            width: max-content;
            max-width: 200px;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .class-day:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        #info-panel {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        #modal-overlay { 
            transition: opacity 0.3s ease;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content { transition: transform 0.3s ease; }
        .loader-container p {
            margin-top: 1rem;
            color: #4b5563;
            text-align: center;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-radius: 50%;
            border-top: 5px solid #3498db;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .register-day-bell {
            position: absolute;
            top: 4px;
            right: 4px;
            color: #ef4444;
            font-size: 0.8rem;
            animation: bell-shake 1s infinite;
        }
        @keyframes bell-shake {
            0%, 100% { transform: rotate(0deg); }
            20%, 60% { transform: rotate(15deg); }
            40%, 80% { transform: rotate(-15deg); }
        }
        .notification-bell {
            position: relative;
            cursor: pointer;
        }
        .notification-bell i {
            font-size: 1.25rem;
        }
        .notification-bell .fa-circle {
            position: absolute;
            top: 0;
            right: 0;
            font-size: 0.5rem;
            color: red;
            transform: translate(50%, -50%);
        }
        
        .conflict-course {
            border: 2px dashed #ef4444;
            background-color: #fecaca;
        }

        .selected-conflict {
            border: 2px dashed #ef4444 !important;
        }

        @media print {
            body { background-color: #ffffff !important; padding: 1cm; font-size: 9pt; }
            .no-print, #course-selection-list, #info-panel, #modal-overlay, #ai-advisor-controls, #print-instruction, #leave-info-panel, .register-day-bell { display: none !important; }
            .max-w-7xl { max-width: 100% !important; padding: 0 !important; margin: 0 !important; }
            .bg-white.rounded-xl.shadow-lg { box-shadow: none !important; border-bottom: 2px solid #ccc; border-radius: 0; padding: 0 0 1rem 0; }
            .calendar-grid { display: flex !important; flex-wrap: wrap !important; justify-content: space-between; gap: 1rem; }
            .month-container { flex: 0 0 32%; box-sizing: border-box; box-shadow: none !important; border: 1px solid #ddd; padding: 0.5rem; page-break-inside: avoid; }
            .month-container h2 { font-size: 11pt; margin-bottom: 0.5rem; }
            .day-grid { gap: 2px; }
            .day-header { font-size: 7pt; padding-bottom: 0.25rem; }
            .day-cell { padding-bottom: 0 !important; position: static; }
            .day-content { position: static; width: 100%; height: 25px; border: 1px solid #eee; color: black !important; font-size: 8pt; }
            .class-day { color: white !important; font-weight: bold; -webkit-print-color-adjust: exact !important; color-adjust: exact !important; }
            .leave-day { border: 1px solid #ddd !important; }
            .tooltip { display: none !important; }
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-7xl mx-auto">
        <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 mb-6 md:mb-8">
            <h1 class="text-xl sm:text-2xl font-bold text-gray-800 mb-2">äº’å‹•å¼èª²ç¨‹è¡Œäº‹æ›†</h1>
            <p class="text-gray-600 text-sm sm:text-base mb-4">è«‹åœ¨ä¸‹æ–¹åˆ—è¡¨ä¸­å‹¾é¸èª²ç¨‹ï¼Œæˆ–é»æ“Šæœˆæ›†ä¸Šçš„æ—¥æœŸæŸ¥çœ‹è€å¸«ã€åœ°å€ç­‰è©³ç´°è³‡è¨Šã€‚</p>
            
            <div id="print-instruction" class="bg-blue-50 border-l-4 border-blue-500 text-blue-700 p-4 rounded-md mb-4" role="alert">
                <p><strong class="font-bold">ğŸ–¨ï¸ åˆ—å°æç¤ºï¼š</strong>è«‹ä½¿ç”¨å¿«æ·éµ <kbd class="px-2 py-1.5 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg">Ctrl</kbd>+<kbd class="px-2 py-1.5 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg">P</kbd> (Mac: <kbd class="px-2 py-1.5 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg">Cmd</kbd>+<kbd class="px-2 py-1.5 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg">P</kbd>)ã€‚åœ¨é è¦½ä¸­å°‡<strong>ç‰ˆé¢è¨­å®šç‚ºã€Œæ©«å‘ã€</strong>ï¼Œå¯å°‡ä¸‰å€‹æœˆä¸¦æ’åˆ—å°ã€‚</p>
            </div>
            
            <div id="leave-info-panel" class="hidden bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-md mb-4 no-print">
                <p class="font-bold">ğŸ’¡ è«‹å‡æ™‚æ•¸æé†’</p>
                <div id="leave-message" class="text-sm mt-2 space-y-3"></div>
            </div>

            <div id="conflict-warning" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md mb-4 no-print" role="alert">
                <p class="font-bold">âš ï¸ è¡å ‚è­¦å‘Šï¼</p>
                <p id="conflict-message" class="text-sm mt-2">æ‚¨é¸æ“‡çš„èª²ç¨‹æ™‚é–“æœ‰é‡ç–Šã€‚</p>
            </div>

        </div>

        <div id="course-selection-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8"></div>
        <div id="calendar-view" class="calendar-grid"></div>
        
        <div id="info-panel" class="mt-8 bg-white rounded-xl shadow-lg p-4 sm:p-6 hidden opacity-0 transform -translate-y-4 no-print">
            <div class="flex justify-between items-center">
                <h2 class="text-lg sm:text-xl font-bold text-gray-800">èª²ç¨‹è©³ç´°è³‡è¨Š</h2>
                <button id="close-info-panel-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="info-panel-content" class="mt-4"></div>
        </div>
    </div>
    
    <!-- Notification Modal -->
    <div id="modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden opacity-0 no-print">
        <div id="notification-modal" class="modal-content bg-white p-6 rounded-lg shadow-lg w-11/12 md:w-1/3 transform scale-95 transition-all duration-300">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">èª²ç¨‹å ±åæé†’</h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="modal-content-text" class="text-gray-700 text-base space-y-2"></div>
            <div class="mt-4 flex justify-end">
                <button onclick="closeModal()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <script>
        // --- èª²ç¨‹è³‡æ–™ ---
        const courses = [
            { id: "c3", name: "AI Agentæ™ºèƒ½åŠ©ç†é–‹ç™¼å¯¦ä½œç­ç¬¬01æœŸ", teacher: "é¦¬æ©å¥‡è€å¸«", start: "114/08/24", end: "114/09/28", days: ["Sunday"], time: "09:00~12:00, 13:00~17:00", color: "#fb923c", address: "700002è‡ºå—å¸‚ä¸­è¥¿å€ä¸­æ­£è·¯240è™Ÿå…­æ¨“(ç‹è€…æœƒè­°å®¤)", capacity: "20äºº", hours: 42, registered: true },
            { id: "c7", name: "è·å ´æƒ…å¢ƒæ—¥èªèˆ‡æ–‡æ³•æ‡‰ç”¨ç­ç¬¬02æœŸ", teacher: "é™³æ˜­èŠ¬è€å¸«", start: "114/09/06", end: "114/12/27", days: ["Saturday"], time: "09:00~12:00", color: "#6366f1", address: "70047è‡ºå—å¸‚ä¸­è¥¿å€å¤§åŸ”è¡—50è™Ÿ2æ¨“(å°å—å¸‚ç¸½å·¥æœƒ2æ¨“æœƒè­°å®¤)", capacity: "20äºº", hours: 45, registered: true },
            { id: "c4", name: "å•†å‹™æ—¥èªæœƒè©±å¯¦å‹™ç­ç¬¬01æœŸ", teacher: "æ—ä½©æ¨ºè€å¸«ã€å±±æœ¬å¼˜å¹¸è€å¸«", start: "114/09/18", end: "114/12/18", days: ["Thursday"], time: "18:30~21:30", color: "#a78bfa", address: "70143è‡ºå—å¸‚æ±å€é•·æ¦®è·¯ä¸€æ®µ225è™ŸB1(æ¨¹å¾·ç§‘æŠ€å¤§å­¸å°å—åˆ†éƒ¨(Bæ•™å®¤))", capacity: "20äºº", hours: 42, registered: true },
            { id: "c10", name: "CANVAè³ªæ„Ÿè¨­è¨ˆç­ç¬¬02æœŸ", teacher: "å¼µå·é¦¨è€å¸«", start: "114/11/11", end: "115/01/06", days: ["Tuesday"], time: "18:30~21:30", color: "#f87171", address: "70041è‡ºå—å¸‚ä¸­è¥¿å€è¥¿é–€è·¯2æ®µ48è™Ÿ1æ¨“(è¨“ç·´æ•™å®¤B)", capacity: "20äºº", hours: 24, registerStart: "114/10/12 12:00", registerEnd: "114/11/08 18:00" },
            { id: "c9", name: "Pythonå¤§æ•¸æ“šåˆ†æèˆ‡ç¶²è·¯çˆ¬èŸ²å¯¦å‹™ç­ç¬¬02æœŸ", teacher: "åŠ‰å“²å®è€å¸«", start: "115/01/07", end: "115/04/15", days: ["Wednesday"], time: "18:30~21:30", color: "#4ade80", address: "70143è‡ºå—å¸‚æ±å€é•·æ¦®è·¯1æ®µ225è™ŸB1(æ¨¹å¾·ç§‘æŠ€å¤§å­¸å°å—åˆ†éƒ¨-(é›»è…¦æ•™å®¤))", capacity: "26äºº", hours: 42, registerStart: "114/12/08 12:00", registerEnd: "115/01/04 18:00" },
            { id: "c8", name: "ç”Ÿæˆå¼AIèˆ‡Canvaå‰µæ„è¨­è¨ˆç­ç¬¬01æœŸ", teacher: "é¡å•Ÿå³°è€å¸«", start: "115/03/18", end: "115/04/29", specificDates: ["115/03/18", "115/03/23", "115/03/25", "115/03/30", "115/04/01", "115/04/08", "115/04/10", "115/04/13", "115/04/15", "115/04/17", "115/04/20", "115/04/22", "115/04/27", "115/04/29"], time: "18:30~21:30", color: "#f472b6", address: "71089è‡ºå—å¸‚æ°¸åº·å€ä¸­å±±è·¯94å··1-3è™Ÿ3æ¨“(B3PCæ•™å®¤)", capacity: "20äºº", hours: 42, registerStart: "115/02/16 12:00", registerEnd: "115/03/15 18:00" }
        ].sort((a, b) => {
            const dateA = rocToDate(a.start);
            const dateB = rocToDate(b.start);
            return dateA - dateB;
        });

        const leaveData = {
            "c7": ["114/09/13"], "c3": ["114/09/14"],
        };
        const weekDayHeaders = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        const dayOfWeekMap = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        function rocToDate(rocDateStr) {
            const [year, month, day] = rocDateStr.split('/').map(Number);
            return new Date(year + 1911, month - 1, day);
        }
        
        function getRegisterDate(course) {
            if (!course.registerStart) return null;
            const dateStr = course.registerStart.split(' ')[0];
            return rocToDate(dateStr).toISOString().split('T')[0];
        }

        const courseSelectionListEl = document.getElementById('course-selection-list');
        const calendarViewEl = document.getElementById('calendar-view');
        const infoPanel = document.getElementById('info-panel');
        const infoPanelContent = document.getElementById('info-panel-content');
        const closeInfoPanelBtn = document.getElementById('close-info-panel-btn');
        const conflictWarningEl = document.getElementById('conflict-warning');
        const conflictMessageEl = document.getElementById('conflict-message');
        const leaveInfoPanelEl = document.getElementById('leave-info-panel');
        const leaveMessageEl = document.getElementById('leave-message');
        const modalOverlay = document.getElementById('modal-overlay');
        const modalContentText = document.getElementById('modal-content-text');
        const closeBtnModal = document.getElementById('close-modal-btn');
        let selectedCourses = new Set();
        let classSchedule = {};
        let lastSelectedDay = null;

        document.addEventListener('DOMContentLoaded', function () {
            buildClassSchedule();
            renderCourseSelectionList();
            renderCalendarView();
            setupEventListeners();
        });

        function getLeaveDatesForCourse(courseId) {
            return (leaveData[courseId] || []).map(d => rocToDate(d).toISOString().split('T')[0]);
        }
        
        function buildClassSchedule() {
            classSchedule = {};
            courses.forEach(course => {
                if (course.specificDates) {
                    course.specificDates.forEach(dateStr => {
                        const date = rocToDate(dateStr);
                        const dateString = date.toISOString().split('T')[0];
                        if (!classSchedule[dateString]) classSchedule[dateString] = [];
                        classSchedule[dateString].push(course);
                    });
                } else {
                    const courseStart = rocToDate(course.start);
                    const courseEnd = rocToDate(course.end);
                    let currentDate = new Date(courseStart);
                    while (currentDate <= courseEnd) {
                        const dayName = dayOfWeekMap[currentDate.getDay()];
                        if (course.days.includes(dayName)) {
                            const dateString = currentDate.toISOString().split('T')[0];
                            if (!classSchedule[dateString]) classSchedule[dateString] = [];
                            classSchedule[dateString].push(course);
                        }
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                }
            });
        }

        function renderCourseSelectionList() {
            const conflictingCourseIds = findConflicts(Array.from(selectedCourses));
            
            courseSelectionListEl.innerHTML = courses.map(course => {
                const isRegistered = course.registered;
                let courseInfo = `<p class="mt-1 text-xs text-gray-500">ä¸Šèª²æ—¥æœŸï¼š${course.start} ~ ${course.end} | ç¸½æ™‚æ•¸ï¼š${course.hours} å°æ™‚</p>`;
                let bellIcon = '';
                let conflictClass = '';
                let conflictLabel = '';
                let leaveInfoHTML = '';
                let conflictInfoHTML = '';

                // Handle registration info for courses not yet registered
                if (!isRegistered) {
                    const registerStart = rocToDate(course.registerStart.split(' ')[0]);
                    const today = new Date();
                    const diffTime = registerStart.getTime() - today.getTime();
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    const countdownText = diffDays > 0 ? `(å€’æ•¸ ${diffDays} å¤©é–‹æ”¾)` : '(å·²é–‹æ”¾)';
                    courseInfo += `<p class="mt-1 text-xs text-gray-500">å ±åæ™‚é–“ï¼š<strong class="text-blue-600">${course.registerStart.split(' ')[0]} ${course.registerStart.split(' ')[1]}</strong> ${countdownText} | å¯è«‹å‡ä¸Šé™ï¼š${(course.hours / 5).toFixed(1)} å°æ™‚</p>`;
                    
                    bellIcon = `
                        <div class="notification-bell cursor-pointer" data-course-id="${course.id}">
                            <i class="fa-solid fa-bell text-red-500"></i>
                            <i class="fa-solid fa-circle text-red-500"></i>
                        </div>
                    `;
                } else {
                     courseInfo += `<p class="mt-1 text-xs text-gray-500">ç¸½æ™‚æ•¸ï¼š${course.hours} å°æ™‚ | å¯è«‹å‡ä¸Šé™ï¼š${(course.hours / 5).toFixed(1)} å°æ™‚</p>`;
                }


                // Handle leave info
                const sessionHours = calculateSessionHours(course.time);
                const totalLeaveHours = (leaveData[course.id] || []).length * sessionHours;
                const remainingLeaveHours = (course.hours / 5) - totalLeaveHours;
                const leaveStatusColor = remainingLeaveHours < 0 ? 'text-red-500' : 'text-green-500';

                // Display leave info for registered courses that have leave data
                if (isRegistered && totalLeaveHours > 0) {
                    leaveInfoHTML = `
                        <p class="mt-2 text-xs text-gray-600 space-y-1">
                            <span class="text-red-500">ç´¯ç©è«‹å‡æ™‚æ•¸ ${totalLeaveHours.toFixed(1)} å°æ™‚</span>ï¼Œ
                            <span class="${leaveStatusColor}">å°šé¤˜ ${remainingLeaveHours.toFixed(1)} å°æ™‚</span>
                        </p>
                    `;
                }
                
                // Handle conflicts for selected and non-selected courses
                const conflictingWith = [];
                const selectedCourseObjects = Array.from(selectedCourses).map(id => courses.find(c => c.id === id));
                selectedCourseObjects.forEach(selectedCourse => {
                    if (selectedCourse.id !== course.id && hasConflict(selectedCourse, course)) {
                        conflictingWith.push(selectedCourse.name.split('ç¬¬')[0]);
                    }
                });

                if (conflictingWith.length > 0) {
                    const conflictMessage = `èˆ‡ ${conflictingWith.join('ã€')} æ™‚é–“é‡ç–Š`;
                    if (selectedCourses.has(course.id)) {
                        conflictInfoHTML = `<p class="mt-2 text-xs text-red-500 font-semibold">âš ï¸ ${conflictMessage}</p>`;
                    } else {
                        conflictInfoHTML = `<p class="mt-2 text-xs text-red-500 font-semibold">âš ï¸ ${conflictMessage}ï¼Œç„¡æ³•å ±å</p>`;
                    }
                }

                return `
                    <label for="checkbox-${course.id}" class="flex items-center p-3 bg-white rounded-lg shadow-sm cursor-pointer hover:bg-gray-50 ${conflictClass}">
                        <input type="checkbox" id="checkbox-${course.id}" data-course-id="${course.id}" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${selectedCourses.has(course.id) ? 'checked' : ''}>
                        <div class="ml-3 text-sm font-medium text-gray-700 flex flex-col w-full">
                            <div class="flex items-center">
                                ${bellIcon}
                                <span class="ml-1">${course.name}</span>
                                <div class="ml-auto h-4 w-4 rounded-full" style="background-color: ${course.color};"></div>
                            </div>
                            ${courseInfo}
                            ${leaveInfoHTML}
                            ${conflictInfoHTML}
                        </div>
                    </label>
                `;
            }).join('');
        }

        function renderCalendarView() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const registerDates = courses.filter(c => c.registerStart).map(c => rocToDate(c.registerStart.split(' ')[0]).toISOString().split('T')[0]);

            calendarViewEl.innerHTML = '';
            
            // Start from 2025/09/01 (current date in the provided data)
            const startYear = 2025;
            const startMonth = 8; // September is month 8 in JS Date object

            // Find the last date of all courses to determine the end of the calendar
            const allDates = courses.flatMap(c => {
                if (c.specificDates) return c.specificDates.map(d => rocToDate(d));
                return [rocToDate(c.start), rocToDate(c.end)];
            });
            const endDate = allDates.length > 0 ? new Date(Math.max.apply(null, allDates)) : new Date(startYear, startMonth);
            
            let currentMonthDate = new Date(startYear, startMonth, 1);
            while (currentMonthDate <= endDate) {
                const year = currentMonthDate.getFullYear();
                const month = currentMonthDate.getMonth();
                const monthContainer = document.createElement('div');
                monthContainer.className = 'month-container';
                let monthHTML = `<h2 class="text-lg sm:text-xl font-bold text-center text-gray-800 mb-4">${year}å¹´ ${month + 1}æœˆ</h2>
                    <div class="day-grid mb-2">${weekDayHeaders.map(day => `<div class="day-header">${day}</div>`).join('')}</div>
                    <div class="day-grid">`;

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                monthHTML += `<div></div>`.repeat(firstDayOfMonth);

                for (let i = 1; i <= new Date(year, month + 1, 0).getDate(); i++) {
                    const date = new Date(year, month, i);
                    const dateString = date.toISOString().split('T')[0];
                    const scheduledClasses = classSchedule[dateString] || [];
                    const isLeaveDay = scheduledClasses.some(c => getLeaveDatesForCourse(c.id).includes(dateString));
                    const isRegisterDay = registerDates.includes(dateString);
                    
                    let dayHTML = '<div class="day-cell">';
                    
                    if (scheduledClasses.length > 0 || isRegisterDay) {
                        let backgroundStyle = '', finalClasses = ['day-content', 'class-day'], tooltipText = [];
                        if (isLeaveDay) finalClasses.push('leave-day');
                        if (date < today) finalClasses.push('past-day');
                        
                        const dayCourses = scheduledClasses.slice(0, 2);
                        if (dayCourses.length === 1) backgroundStyle = `background-color: ${dayCourses[0].color};`;
                        else if (dayCourses.length > 1) backgroundStyle = `background: linear-gradient(135deg, ${dayCourses[0].color} 50%, ${dayCourses[1].color} 50%);`;

                        tooltipText = scheduledClasses.map(c => c.name.split('ç¬¬')[0]);
                        dayHTML += `<div class="${finalClasses.join(' ')}" style="${backgroundStyle}" data-date="${dateString}">
                                        <span class="day-number">${i}</span>
                                        <div class="tooltip">${tooltipText.join('<br>')}</div>
                                    </div>`;
                    } else {
                        dayHTML += `<div class="day-content"><span class="day-number">${i}</span></div>`;
                    }

                    if (isRegisterDay) {
                        dayHTML = dayHTML.replace('</div class="day-cell">', `<i class="fas fa-bell register-day-bell"></i></div>`);
                    }

                    monthHTML += dayHTML + '</div>';
                }

                monthContainer.innerHTML = monthHTML + '</div>';
                calendarViewEl.appendChild(monthContainer);
                currentMonthDate.setMonth(currentMonthDate.getMonth() + 1);
            }
        }

        function setupEventListeners() {
            courseSelectionListEl.addEventListener('change', (e) => {
                if (e.target.type !== 'checkbox') return;
                const courseId = e.target.dataset.courseId;
                e.target.checked ? selectedCourses.add(courseId) : selectedCourses.delete(courseId);
                updateSelectionState();
            });
            calendarViewEl.addEventListener('click', (e) => {
                const dayElement = e.target.closest('.class-day');
                if (dayElement) showInfoPanel(dayElement.dataset.date, dayElement);
            });
            closeInfoPanelBtn.addEventListener('click', hideInfoPanel);
            
            // Add click listener for notification bells
            courseSelectionListEl.addEventListener('click', (e) => {
                const bellElement = e.target.closest('.notification-bell');
                if (bellElement) {
                    const courseId = bellElement.dataset.courseId;
                    const course = courses.find(c => c.id === courseId);
                    if (course) {
                        showNotificationModal(course);
                    }
                }
            });
            closeBtnModal.addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', (e) => {
                if (e.target.id === 'modal-overlay') {
                    closeModal();
                }
            });
        }
        
        function calculateSessionHours(timeStr) {
            return timeStr.split(',').reduce((total, interval) => {
                const [start, end] = interval.trim().split('~').map(t => {
                    const [h, m] = t.split(':').map(Number);
                    return h + m / 60;
                });
                return total + (Math.abs(end - start));
            }, 0);
        }
        
        function parseTime(timeStr) {
            return timeStr.split(',').map(interval => {
                const [start, end] = interval.trim().split('~').map(t => {
                    const [h, m] = t.split(':').map(Number);
                    return h * 60 + m;
                });
                return { start, end };
            });
        }

        function hasConflict(course1, course2) {
            const dates1 = course1.specificDates ? course1.specificDates.map(d => rocToDate(d).toISOString().split('T')[0]) : Object.keys(classSchedule).filter(date => classSchedule[date].some(c => c.id === course1.id));
            const dates2 = course2.specificDates ? course2.specificDates.map(d => rocToDate(d).toISOString().split('T')[0]) : Object.keys(classSchedule).filter(date => classSchedule[date].some(c => c.id === course2.id));
            
            const sharedDates = dates1.filter(date => dates2.includes(date));
            if (sharedDates.length === 0) return false;

            for (const date of sharedDates) {
                const times1 = parseTime(course1.time);
                const times2 = parseTime(course2.time);
                for (const t1 of times1) {
                    for (const t2 of times2) {
                        if (Math.max(t1.start, t2.start) < Math.min(t1.end, t2.end)) {
                            return true;
                        }
                    }
                }
            }
            return false;
        }

        function findConflicts(courseIds) {
            const courseObjects = courseIds.map(id => courses.find(c => c.id === id));
            const conflicts = new Set();
            
            for (let i = 0; i < courseObjects.length; i++) {
                for (let j = i + 1; j < courseObjects.length; j++) {
                    if (hasConflict(courseObjects[i], courseObjects[j])) {
                        conflicts.add(courseObjects[i].id);
                        conflicts.add(courseObjects[j].id);
                    }
                }
            }
            return Array.from(conflicts);
        }

        function updateSelectionState() {
            const conflictingCourseIds = findConflicts(Array.from(selectedCourses));
            const hasConflicts = conflictingCourseIds.length > 0;
            
            if (hasConflicts) {
                const conflictDetails = conflictingCourseIds.map(id => {
                    const course = courses.find(c => c.id === id);
                    return course.name.split('ç¬¬')[0];
                }).join(' èˆ‡ ');
                conflictMessageEl.textContent = `æ‚¨é¸æ“‡çš„èª²ç¨‹ "${conflictDetails}" æ™‚é–“é‡ç–Šã€‚`;
            }

            conflictWarningEl.classList.toggle('hidden', !hasConflicts);
            renderCourseSelectionList();
            updateLeaveInfo();
        }

        function updateLeaveInfo() {
            if (selectedCourses.size === 0) {
                leaveInfoPanelEl.classList.add('hidden');
                return;
            }

            let messages = [];
            let hasLeave = false;
            
            selectedCourses.forEach(courseId => {
                const course = courses.find(c => c.id === courseId);
                const courseLeaveDates = leaveData[courseId] || [];
                if (!course || courseLeaveDates.length === 0) return;

                hasLeave = true;
                const sessionHours = calculateSessionHours(course.time);
                const totalLeaveHours = courseLeaveDates.length * sessionHours;
                const maxLeaveHours = course.hours / 5;
                const remainingLeaveHours = maxLeaveHours - totalLeaveHours;
                const isOverLimit = totalLeaveHours > maxLeaveHours;

                messages.push(`
                    <div class="p-2 ${isOverLimit ? 'bg-red-50 rounded-md' : ''}">
                        <p class="font-semibold text-gray-800">${course.name.split('ç¬¬')[0]}</p>
                        <div class="grid grid-cols-3 gap-2 text-center mt-1.5">
                            <div><span class="text-xs text-gray-500">æ™‚æ•¸ä¸Šé™</span><p class="font-bold text-blue-600">${maxLeaveHours.toFixed(1)}</p></div>
                            <div><span class="text-xs text-gray-500">å·²è«‹å‡</span><p class="font-bold ${isOverLimit ? 'text-red-600' : 'text-gray-800'}">${totalLeaveHours.toFixed(1)}</p></div>
                            <div><span class="text-xs text-gray-500">å‰©é¤˜</span><p class="font-bold ${remainingLeaveHours < 0 ? 'text-red-600' : 'text-green-600'}">${remainingLeaveHours.toFixed(1)}</p></div>
                        </div>
                        ${isOverLimit ? `<p class="text-red-600 text-xs mt-2 text-center font-semibold">âš ï¸ å·²è¶…éè«‹å‡æ™‚æ•¸ä¸Šé™ï¼</p>` : ''}
                    </div>`);
            });

            leaveMessageEl.innerHTML = messages.join('');
            leaveInfoPanelEl.classList.toggle('hidden', !hasLeave);
        }

        function showInfoPanel(dateString, dayElement) {
            if (lastSelectedDay) lastSelectedDay.classList.remove('day-selected');
            dayElement.classList.add('day-selected');
            lastSelectedDay = dayElement;

            const classes = classSchedule[dateString];
            const date = new Date(dateString);
            const formattedDate = date.toLocaleDateString('zh-Hant', { year: 'numeric', month: 'long', day: 'numeric' });
            
            let contentHTML = `<p class="text-gray-600 mb-4">æ—¥æœŸï¼š${formattedDate}</p>`;
            classes.forEach(course => {
                const isLeave = getLeaveDatesForCourse(course.id).includes(dateString);
                const registerStartROC = course.registerStart?.split(' ')[0].split('/') || [];
                const registerEndROC = course.registerEnd?.split(' ')[0].split('/') || [];
                const registerStartDisplay = registerStartROC.length > 0 ? `${parseInt(registerStartROC[0])}å¹´${parseInt(registerStartROC[1])}æœˆ${parseInt(registerStartROC[2])}æ—¥ ${course.registerStart.split(' ')[1]}` : 'å·²å ±å';
                const registerEndDisplay = registerEndROC.length > 0 ? `~ ${parseInt(registerEndROC[0])}å¹´${parseInt(registerEndROC[1])}æœˆ${parseInt(registerEndROC[2])}æ—¥ ${course.registerEnd.split(' ')[1]}` : '';

                let leaveInfoHTML = '';
                if (isLeave) {
                    const sessionHours = calculateSessionHours(course.time);
                    const totalLeaveHours = (leaveData[course.id] || []).length * sessionHours;
                    const maxLeaveHours = course.hours / 5;
                    const remainingLeaveHours = maxLeaveHours - totalLeaveHours;
                    leaveInfoHTML = `<div class="mt-3 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-3 rounded-md text-sm space-y-1">
                                <p class="font-bold flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>è«‹å‡æ™‚æ•¸èªªæ˜</p>
                                <p>æ™‚æ•¸ä¸Šé™: <span class="font-semibold text-blue-700">${maxLeaveHours.toFixed(1)} å°æ™‚</span></p>
                                <p>æœ¬æ¬¡è«‹å‡: <span class="font-semibold">${sessionHours.toFixed(1)} å°æ™‚</span></p>
                                <p>ç´¯è¨ˆè«‹å‡: <span class="font-semibold ${totalLeaveHours > maxLeaveHours ? 'text-red-600' : ''}">${totalLeaveHours.toFixed(1)} å°æ™‚</span></p>
                                <p>å‰©é¤˜æ™‚æ•¸: <span class="font-bold ${remainingLeaveHours < 0 ? 'text-red-600' : 'text-green-700'}">${remainingLeaveHours.toFixed(1)} å°æ™‚</span></p>
                            </div>`;
                }

                contentHTML += `
                    <div class="border-l-4 p-4 rounded-r-lg mb-3" style="border-color: ${course.color}; background-color: ${course.color}1A;">
                        <p class="font-bold text-gray-900 flex items-center">${course.name}${isLeave ? '<span class="ml-2 bg-yellow-200 text-yellow-800 text-xs font-medium px-2.5 py-0.5 rounded-full">å·²è«‹å‡</span>' : ''}</p>
                        <div class="mt-2 text-sm text-gray-700 space-y-1">
                            <p><strong class="font-semibold">ä¸Šèª²æ—¥æœŸï¼š</strong>${course.start} ~ ${course.end}</p>
                            <p><strong class="font-semibold">ä¸Šèª²æ™‚é–“ï¼š</strong>${course.time}</p>
                            <p><strong class="font-semibold">æˆèª²è€å¸«ï¼š</strong>${course.teacher}</p>
                            <p><strong class="font-semibold">ä¸Šèª²åœ°å€ï¼š</strong>${course.address}</p>
                            <p><strong class="font-semibold">ç¸½è¨“ç·´æ™‚æ•¸ï¼š</strong>${course.hours} å°æ™‚</p>
                            <p><strong class="font-semibold">å¯è«‹å‡ä¸Šé™ï¼š</strong>${(course.hours / 5).toFixed(1)} å°æ™‚</p>
                            <p><strong class="font-semibold">å ±åæ—¥æœŸï¼š</strong>${registerStartDisplay} ${registerEndDisplay}</p>
                        </div>
                        ${leaveInfoHTML}
                    </div>`;
            });

            infoPanelContent.innerHTML = contentHTML;
            infoPanel.classList.remove('hidden');
            setTimeout(() => {
                infoPanel.classList.remove('opacity-0', '-translate-y-4');
                infoPanel.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 10);
        }

        function hideInfoPanel() {
            if (lastSelectedDay) { lastSelectedDay.classList.remove('day-selected'); lastSelectedDay = null; }
            infoPanel.classList.add('opacity-0', '-translate-y-4');
            setTimeout(() => infoPanel.classList.add('hidden'), 300);
        }

        function showNotificationModal(course) {
            const registerStart = rocToDate(course.registerStart.split(' ')[0]);
            const registerStartROC = course.registerStart.split(' ')[0].split('/');
            const registerStartDisplay = `${parseInt(registerStartROC[0])}å¹´${parseInt(registerStartROC[1])}æœˆ${parseInt(registerStartROC[2])}æ—¥`;
            const registerStartFull = `${registerStartDisplay} ${course.registerStart.split(' ')[1]}`;
            
            const today = new Date();
            const diffTime = registerStart.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            modalContentText.innerHTML = `
                <p><strong>èª²ç¨‹åç¨±ï¼š</strong>${course.name}</p>
                <p><strong>å ±åæ™‚é–“ï¼š</strong>${registerStartFull}</p>
                <p><strong>é–‹æ”¾å ±åå€’æ•¸ï¼š</strong><span class="font-bold text-red-600">${diffDays > 0 ? diffDays : 0}</span> å¤©</p>
            `;
            
            modalOverlay.classList.remove('hidden', 'opacity-0');
            modalOverlay.classList.add('flex', 'opacity-100');
            document.getElementById('notification-modal').classList.remove('scale-95');
        }

        function closeModal() {
            modalOverlay.classList.add('opacity-0');
            document.getElementById('notification-modal').classList.add('scale-95');
            setTimeout(() => {
                modalOverlay.classList.add('hidden');
            }, 300);
        }
    </script>
</body>
</html>
