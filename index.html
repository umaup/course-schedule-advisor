<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº’å‹•å¼èª²ç¨‹è¡Œäº‹æ›† (AI å­¸ç¿’é¡§å•)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        .month-container {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .day-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .day-cell {
            position: relative;
            width: 100%;
            padding-bottom: 100%; /* Aspect ratio 1:1 */
        }
        .day-content {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem;
            font-size: 0.75rem; /* Slightly smaller for better fit */
            color: #4b5563;
        }
        .day-header {
            text-align: center;
            font-weight: 500;
            color: #6b7280;
            padding-bottom: 0.5rem;
            font-size: 0.75rem;
        }
        .class-day {
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .class-day:hover, .day-selected {
            transform: scale(1.1);
            z-index: 5;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            border: 2px solid #3b82f6;
        }
        /* --- NEW: è«‹å‡æ—¥çš„æ¨£å¼ --- */
        .leave-day {
            background-color: #fef9c3 !important; /* æ·ºé»ƒè‰²èƒŒæ™¯ */
            color: #713f12 !important; /* æ·±é»ƒè‰²æ–‡å­— */
            border: 2px dashed #facc15; /* é»ƒè‰²è™›ç·šé‚Šæ¡† */
        }
        .leave-day .day-number {
            text-decoration: none; /* å¦‚æœè«‹å‡æ—¥æ˜¯éå»çš„æ—¥æœŸï¼Œå–æ¶ˆåˆªé™¤ç·š */
        }
        /* å·²ä¸Šèª²æ—¥æœŸçš„æ¨£å¼ */
        .past-day {
            opacity: 0.6;
        }
        .past-day .day-number {
            text-decoration: line-through;
        }
        .tooltip {
            position: absolute;
            visibility: hidden;
            background-color: #1f2937;
            color: #ffffff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            z-index: 20;
            bottom: 105%;
            left: 50%;
            transform: translateX(-50%);
            white-space: normal; /* Allow wrapping */
            width: max-content;
            max-width: 200px;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .class-day:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        #info-panel {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        #modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .loader-container p {
            margin-top: 1rem;
            color: #4b5563;
            text-align: center;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-radius: 50%;
            border-top: 5px solid #3498db;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- å‹å–„åˆ—å°æ¨£å¼ (æ©«å‘) --- */
        @media print {
            body {
                background-color: #ffffff !important;
                padding: 1cm; /* çµ¦äºˆé é¢ä¸€äº›é‚Šç•Œ */
                font-size: 9pt; /* ç¸®å°æ•´é«”å­—é«” */
            }
            /* éš±è—ä¸éœ€è¦åˆ—å°çš„å…ƒç´  */
            .no-print, #course-selection-list, #info-panel, #modal-overlay, #ai-advisor-controls, #print-instruction, #leave-info-panel {
                display: none !important;
            }
            .max-w-7xl {
                max-width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            .bg-white.rounded-xl.shadow-lg {
                box-shadow: none !important;
                border-bottom: 2px solid #ccc;
                border-radius: 0;
                padding: 0 0 1rem 0;
            }
            /* å°‡æœˆæ›†æ”¹ç‚º flex æ’åˆ—ï¼Œä»¥å¯¦ç¾å¤šæ¬„ */
            .calendar-grid {
                display: flex !important;
                flex-wrap: wrap !important;
                justify-content: space-between;
                gap: 1rem;
            }
            .month-container {
                flex: 0 0 32%; /* è¨­å®šæ¯å€‹æœˆä»½å®¹å™¨çš„å¯¬åº¦ï¼Œä½¿å…¶åœ¨ä¸€è¡Œä¸­å®¹ç´ä¸‰å€‹ */
                box-sizing: border-box;
                box-shadow: none !important;
                border: 1px solid #ddd;
                padding: 0.5rem;
                page-break-inside: avoid; /* é¿å…æœˆä»½ä¸­é–“è¢«åˆ‡æ–· */
            }
            .month-container h2 {
                font-size: 11pt;
                margin-bottom: 0.5rem;
            }
            .day-grid {
                gap: 2px;
            }
            .day-header {
                font-size: 7pt;
                padding-bottom: 0.25rem;
            }
            .day-cell {
                padding-bottom: 0 !important; /* ç§»é™¤é•·å¯¬æ¯” */
                position: static;
            }
            .day-content {
                position: static;
                width: 100%;
                height: 25px; /* è¨­å®šå›ºå®šé«˜åº¦ */
                border: 1px solid #eee;
                color: black !important; /* ç¢ºä¿ç„¡èª²ç¨‹æ—¥æœŸçš„æ–‡å­—æ˜¯é»‘è‰² */
                font-size: 8pt;
            }
            .class-day {
                color: white !important; /* ç¢ºä¿æ—¥æœŸæ•¸å­—åœ¨å½©è‰²èƒŒæ™¯ä¸Šæ˜¯ç™½è‰² */
                font-weight: bold;
                -webkit-print-color-adjust: exact !important; /* å¼·åˆ¶åˆ—å°èƒŒæ™¯è‰² */
                color-adjust: exact !important;
            }
             .leave-day {
                border: 1px solid #ddd !important;
            }
            .tooltip {
                display: none !important; /* åˆ—å°æ™‚éš±è—æç¤º */
            }
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-7xl mx-auto">
        <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 mb-6 md:mb-8">
            <h1 class="text-xl sm:text-2xl font-bold text-gray-800 mb-2">äº’å‹•å¼èª²ç¨‹è¡Œäº‹æ›† & AI å­¸ç¿’é¡§å•</h1>
            <p class="text-gray-600 text-sm sm:text-base mb-4">è«‹åœ¨ä¸‹æ–¹åˆ—è¡¨ä¸­å‹¾é¸èª²ç¨‹ï¼Œæˆ–é»æ“Šæœˆæ›†ä¸Šçš„æ—¥æœŸæŸ¥çœ‹è€å¸«ã€åœ°å€ç­‰è©³ç´°è³‡è¨Šï¼Œä¸¦å¯ä½¿ç”¨ AI åŠŸèƒ½ç²å–å€‹äººåŒ–çš„å­¸ç¿’è·¯å¾‘å»ºè­°ã€‚</p>
            
            <div id="print-instruction" class="bg-blue-50 border-l-4 border-blue-500 text-blue-700 p-4 rounded-md mb-4" role="alert">
                <p><strong class="font-bold">ğŸ–¨ï¸ åˆ—å°æç¤ºï¼š</strong>è«‹ä½¿ç”¨å¿«æ·éµ <kbd class="px-2 py-1.5 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg">Ctrl</kbd>+<kbd class="px-2 py-1.5 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg">P</kbd> (Mac: <kbd class="px-2 py-1.5 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg">Cmd</kbd>+<kbd class="px-2 py-1.5 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg">P</kbd>)ã€‚åœ¨é è¦½ä¸­å°‡<strong>ç‰ˆé¢è¨­å®šç‚ºã€Œæ©«å‘ã€</strong>ï¼Œå¯å°‡ä¸‰å€‹æœˆä¸¦æ’åˆ—å°ã€‚</p>
            </div>

            <!-- MODIFIED: Leave Calculation & Warning -->
            <div id="leave-info-panel" class="hidden bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-md mb-4 no-print">
                <p class="font-bold">ğŸ’¡ è«‹å‡æ™‚æ•¸æé†’</p>
                <div id="leave-message" class="text-sm mt-2 space-y-3"></div>
            </div>

            <div id="conflict-warning" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md mb-4 no-print" role="alert">
                <p class="font-bold">âš ï¸ è¡å ‚è­¦å‘Šï¼</p>
                <p id="conflict-message" class="text-sm mt-2">æ‚¨é¸æ“‡çš„èª²ç¨‹æ™‚é–“æœ‰é‡ç–Šã€‚</p>
            </div>

            <div id="ai-advisor-controls" class="flex flex-col sm:flex-row items-start sm:items-center gap-4 p-4 bg-slate-50 rounded-lg">
                 <button id="get-recommendation-btn" disabled class="w-full sm:w-auto bg-blue-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-600 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:shadow-none transition-all duration-300">
                     âœ¨ AI å­¸ç¿’è·¯å¾‘å»ºè­°
                 </button>
                 <p id="selection-helper" class="text-sm text-gray-500">è«‹è‡³å°‘é¸æ“‡ä¸€é–€èª²ç¨‹ä»¥å•Ÿç”¨ AI å»ºè­°åŠŸèƒ½ã€‚</p>
            </div>
        </div>

        <div id="course-selection-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8"></div>
        <div id="calendar-view" class="calendar-grid"></div>
        <div id="info-panel" class="mt-8 bg-white rounded-xl shadow-lg p-4 sm:p-6 hidden opacity-0 transform -translate-y-4 no-print">
            <div class="flex justify-between items-center">
                <h2 class="text-lg sm:text-xl font-bold text-gray-800">èª²ç¨‹è©³ç´°è³‡è¨Š</h2>
                <button id="close-info-panel-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="info-panel-content" class="mt-4"></div>
        </div>
    </div>

    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 z-50 hidden opacity-0 no-print">
        <div class="modal-content bg-white rounded-lg shadow-2xl w-full max-w-lg sm:max-w-2xl max-h-[90vh] flex flex-col transform scale-95">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-base sm:text-lg font-bold text-gray-800">âœ¨ æ‚¨çš„å€‹äººåŒ–å­¸ç¿’å»ºè­°</h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="modal-body" class="p-4 sm:p-6 overflow-y-auto">
                <div id="loader" class="flex flex-col justify-center items-center h-48 loader-container">
                    <div class="loader"></div>
                    <p class="text-sm">AI æ­£åœ¨ç‚ºæ‚¨é€²è¡Œæ·±åº¦åˆ†æï¼Œé€™å¯èƒ½éœ€è¦ç´„ 30 ç§’ï¼Œè«‹ç¨å€™ç‰‡åˆ»ã€‚</p>
                </div>
                <div id="ai-response" class="prose max-w-none hidden"></div>
            </div>
        </div>
    </div>

    <script>
        const courses = [
            { id: "c1", name: "AIæ™ºæ…§ç¹ªåœ–è¨­è¨ˆèˆ‡AIGCåª’é«”è¨­è¨ˆç­ç¬¬01æœŸ", teacher: "é™³ç‘œèŠ³è€å¸«", start: "114/07/18", end: "114/08/29", specificDates: ["114/07/18", "114/07/23", "114/07/25", "114/07/30", "114/08/01", "114/08/06", "114/08/08", "114/08/15", "114/08/20", "114/08/22", "114/08/29"], time: "18:30~21:30", color: "#38bdf8", address: "70101è‡ºå—å¸‚æ±å€å¤§å­¸è·¯1è™ŸæˆåŠŸæ ¡å€(æˆåŠŸå¤§å­¸è³‡è¨Šå·¥ç¨‹ç³»2æ¨“(65203é›»è…¦æ•™å®¤))", capacity: "23äºº", hours: 36 },
            { id: "c3", name: "AI Agentæ™ºèƒ½åŠ©ç†é–‹ç™¼å¯¦ä½œç­ç¬¬01æœŸ", teacher: "é¦¬æ©å¥‡è€å¸«", start: "114/08/24", end: "114/09/28", days: ["Sunday"], time: "09:00~12:00, 13:00~17:00", color: "#fb923c", address: "700002è‡ºå—å¸‚ä¸­è¥¿å€ä¸­æ­£è·¯240è™Ÿå…­æ¨“(ç‹è€…æœƒè­°å®¤)", capacity: "20äºº", hours: 42 },
            { id: "c4", name: "å•†å‹™æ—¥èªæœƒè©±å¯¦å‹™ç­ç¬¬01æœŸ", teacher: "æ—ä½©æ¨ºè€å¸«ã€å±±æœ¬å¼˜å¹¸è€å¸«", start: "114/09/18", end: "114/12/18", days: ["Thursday"], time: "18:30~21:30", color: "#a78bfa", address: "70143è‡ºå—å¸‚æ±å€é•·æ¦®è·¯ä¸€æ®µ225è™ŸB1(æ¨¹å¾·ç§‘æŠ€å¤§å­¸å°å—åˆ†éƒ¨(Bæ•™å®¤))", capacity: "20äºº", hours: 42 },
            { id: "c7", name: "è·å ´æƒ…å¢ƒæ—¥èªèˆ‡æ–‡æ³•æ‡‰ç”¨ç­ç¬¬02æœŸ", teacher: "é™³æ˜­èŠ¬è€å¸«", start: "114/09/06", end: "114/12/27", days: ["Saturday"], time: "09:00~12:00", color: "#6366f1", address: "70047è‡ºå—å¸‚ä¸­è¥¿å€å¤§åŸ”è¡—50è™Ÿ2æ¨“(å°å—å¸‚ç¸½å·¥æœƒ2æ¨“æœƒè­°å®¤)", capacity: "20äºº", hours: 45 },
            { id: "c8", name: "ç”Ÿæˆå¼AIèˆ‡Canvaå‰µæ„è¨­è¨ˆç­ç¬¬01æœŸ", teacher: "é¡å•Ÿå³°è€å¸«", start: "115/03/18", end: "115/04/29", specificDates: ["115/03/18", "115/03/23", "115/03/25", "115/03/30", "115/04/01", "115/04/08", "115/04/10", "115/04/13", "115/04/15", "115/04/17", "115/04/20", "115/04/22", "115/04/27", "115/04/29"], time: "18:30~21:30", color: "#f472b6", address: "71089è‡ºå—å¸‚æ°¸åº·å€ä¸­å±±è·¯94å··1-3è™Ÿ3æ¨“(B3PCæ•™å®¤)", capacity: "20äºº", hours: 42 }
        ];

        // --- NEW: è«‹å‡è³‡æ–™ ---
        // key æ˜¯èª²ç¨‹ IDï¼Œvalue æ˜¯æ°‘åœ‹å¹´æ ¼å¼çš„æ—¥æœŸé™£åˆ—
        const leaveData = {
            "c7": ["114/09/13"], // è·å ´æƒ…å¢ƒæ—¥èª (é€±å…­)
            "c3": ["114/09/14"], // AI Agent (é€±æ—¥) - åªæ˜¯ç¯„ä¾‹ï¼Œæ‚¨å¯ä»¥è‡ªè¡Œå¢æ¸›
        };

        const weekDayHeaders = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

        function rocToDate(rocDateStr) {
            const [year, month, day] = rocDateStr.split('/').map(Number);
            return new Date(year + 1911, month - 1, day);
        }

        const getRecommendationBtn = document.getElementById('get-recommendation-btn');
        const selectionHelper = document.getElementById('selection-helper');
        const modalOverlay = document.getElementById('modal-overlay');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const loader = document.getElementById('loader');
        const aiResponse = document.getElementById('ai-response');
        const courseSelectionListEl = document.getElementById('course-selection-list');
        const calendarViewEl = document.getElementById('calendar-view');
        const infoPanel = document.getElementById('info-panel');
        const infoPanelContent = document.getElementById('info-panel-content');
        const closeInfoPanelBtn = document.getElementById('close-info-panel-btn');
        const conflictWarningEl = document.getElementById('conflict-warning');
        const conflictMessageEl = document.getElementById('conflict-message');
        const leaveInfoPanelEl = document.getElementById('leave-info-panel');
        const leaveMessageEl = document.getElementById('leave-message');

        let selectedCourses = new Set();
        let classSchedule = {};
        let lastSelectedDay = null;

        document.addEventListener('DOMContentLoaded', function () {
            buildClassSchedule();
            renderCourseSelectionList();
            renderCalendarView();
            setupEventListeners();
        });
        
        function getLeaveDatesForCourse(courseId) {
            return (leaveData[courseId] || []).map(d => rocToDate(d).toISOString().split('T')[0]);
        }
        
        function buildClassSchedule() {
            classSchedule = {};
            courses.forEach(course => {
                const processDate = (date) => {
                    const dateString = date.toISOString().split('T')[0];
                    if (!classSchedule[dateString]) classSchedule[dateString] = [];
                    classSchedule[dateString].push(course);
                };
                if (course.specificDates) {
                    course.specificDates.forEach(dateStr => processDate(rocToDate(dateStr)));
                } else {
                    let currentDate = rocToDate(course.start);
                    const courseEnd = rocToDate(course.end);
                    const courseDays = course.days.map(d => d.toLowerCase());
                    while (currentDate <= courseEnd) {
                        const dayName = currentDate.toLocaleString('en-US', { weekday: 'long' }).toLowerCase();
                        if (courseDays.includes(dayName)) {
                            processDate(new Date(currentDate));
                        }
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                }
            });
        }

        function renderCourseSelectionList() {
            courseSelectionListEl.innerHTML = courses.map(course => `
                <label for="checkbox-${course.id}" class="flex items-center p-3 bg-white rounded-lg shadow-sm cursor-pointer hover:bg-gray-50">
                    <input type="checkbox" id="checkbox-${course.id}" data-course-id="${course.id}" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <span class="ml-3 text-sm font-medium text-gray-700">${course.name}</span>
                    <div class="ml-auto h-4 w-4 rounded-full" style="background-color: ${course.color};"></div>
                </label>
            `).join('');
        }

        function renderCalendarView() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            calendarViewEl.innerHTML = '';
            const allDates = courses.flatMap(c => c.specificDates ? c.specificDates.map(d => rocToDate(d)) : [rocToDate(c.start), rocToDate(c.end)]);
            if (allDates.length === 0) return;

            const startDate = rocToDate("114/09/01");
            const endDate = new Date(Math.max.apply(null, allDates));

            let currentMonthDate = new Date(startDate);
            while (currentMonthDate <= endDate) {
                const year = currentMonthDate.getFullYear();
                const month = currentMonthDate.getMonth();
                
                const monthContainer = document.createElement('div');
                monthContainer.className = 'month-container';
                
                let monthHTML = `
                    <h2 class="text-lg sm:text-xl font-bold text-center text-gray-800 mb-4">${year}å¹´ ${month + 1}æœˆ</h2>
                    <div class="day-grid mb-2">${weekDayHeaders.map(day => `<div class="day-header">${day}</div>`).join('')}</div>
                    <div class="day-grid">`;
                
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                monthHTML += `<div></div>`.repeat(firstDayOfMonth);

                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(year, month, i);
                    const dateString = date.toISOString().split('T')[0];
                    const scheduledClasses = classSchedule[dateString];
                    
                    let dayHTML = '<div class="day-cell">';
                    if (scheduledClasses?.length > 0) {
                        let isLeaveDay = scheduledClasses.some(c => getLeaveDatesForCourse(c.id).includes(dateString));
                        let backgroundStyle = '';
                        let tooltipText = scheduledClasses.map(c => {
                             const courseLeaveDates = getLeaveDatesForCourse(c.id);
                             return c.name.split('ç¬¬')[0] + (courseLeaveDates.includes(dateString) ? ' (å·²è«‹å‡)' : '');
                        }).join('<br>');
                        
                        if (scheduledClasses.length === 1) {
                            backgroundStyle = `background-color: ${scheduledClasses[0].color};`;
                        } else {
                            const colors = scheduledClasses.map(c => c.color).slice(0, 2);
                            backgroundStyle = colors.length > 1 ? `background: linear-gradient(135deg, ${colors[0]} 50%, ${colors[1]} 50%);` : `background-color: ${colors[0]};`;
                        }
                        
                        const dayClasses = ['day-content', 'class-day'];
                        if (isLeaveDay) dayClasses.push('leave-day');
                        if (date < today) dayClasses.push('past-day');

                        dayHTML += `
                            <div class="${dayClasses.join(' ')}" style="${backgroundStyle}" data-date="${dateString}">
                                <span class="day-number">${i}</span>
                                <div class="tooltip">${tooltipText}</div>
                            </div>`;
                    } else {
                        dayHTML += `<div class="day-content"><span class="day-number">${i}</span></div>`;
                    }
                    monthHTML += dayHTML + '</div>';
                }

                monthContainer.innerHTML = monthHTML + '</div>';
                calendarViewEl.appendChild(monthContainer);
                currentMonthDate.setMonth(currentMonthDate.getMonth() + 1);
            }
        }

        function setupEventListeners() {
            courseSelectionListEl.addEventListener('change', (e) => {
                if (e.target.type !== 'checkbox') return;
                const courseId = e.target.dataset.courseId;
                e.target.checked ? selectedCourses.add(courseId) : selectedCourses.delete(courseId);
                updateSelectionState();
            });

            calendarViewEl.addEventListener('click', (e) => {
                const dayElement = e.target.closest('.class-day');
                if (dayElement) showInfoPanel(dayElement.dataset.date, dayElement);
            });

            closeInfoPanelBtn.addEventListener('click', hideInfoPanel);
            getRecommendationBtn.addEventListener('click', handleGetRecommendation);
            closeModalBtn.addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) closeModal();
            });
        }
        
        function calculateSessionHours(timeStr) {
            return timeStr.split(',').reduce((total, interval) => {
                const [start, end] = interval.trim().split('~').map(t => {
                    const [h, m] = t.split(':').map(Number);
                    return h + m / 60;
                });
                return total + (end - start);
            }, 0);
        }

        function updateSelectionState() {
            const hasSelection = selectedCourses.size > 0;
            getRecommendationBtn.disabled = !hasSelection;
            selectionHelper.textContent = hasSelection ? `å·²é¸æ“‡ ${selectedCourses.size} é–€èª²ç¨‹ã€‚` : 'è«‹è‡³å°‘é¸æ“‡ä¸€é–€èª²ç¨‹ä»¥å•Ÿç”¨ AI å»ºè­°åŠŸèƒ½ã€‚';
            checkForConflicts();
            updateLeaveInfo();
        }

        // --- MODIFIED: æ›´æ–°è«‹å‡è³‡è¨Šé¢æ¿ï¼Œé¡¯ç¤ºæ›´è©³ç´°çš„è³‡è¨Š ---
        function updateLeaveInfo() {
            if (selectedCourses.size === 0) {
                leaveInfoPanelEl.classList.add('hidden');
                return;
            }

            let messages = [];
            let hasLeave = false;
            
            selectedCourses.forEach(courseId => {
                const course = courses.find(c => c.id === courseId);
                const courseLeaveDates = leaveData[courseId] || [];
                if (!course || courseLeaveDates.length === 0) return;

                hasLeave = true;
                const sessionHours = calculateSessionHours(course.time);
                const totalLeaveHours = courseLeaveDates.length * sessionHours;
                const maxLeaveHours = course.hours / 5;
                const remainingLeaveHours = maxLeaveHours - totalLeaveHours;
                const isOverLimit = totalLeaveHours > maxLeaveHours;

                messages.push(`
                    <div class="p-2 ${isOverLimit ? 'bg-red-50 rounded-md' : ''}">
                        <p class="font-semibold text-gray-800">${course.name.split('ç¬¬')[0]}</p>
                        <div class="grid grid-cols-3 gap-2 text-center mt-1.5">
                            <div>
                                <span class="text-xs text-gray-500">æ™‚æ•¸ä¸Šé™</span>
                                <p class="font-bold text-blue-600">${maxLeaveHours.toFixed(1)}</p>
                            </div>
                            <div>
                                <span class="text-xs text-gray-500">å·²è«‹å‡</span>
                                <p class="font-bold ${isOverLimit ? 'text-red-600' : 'text-gray-800'}">${totalLeaveHours.toFixed(1)}</p>
                            </div>
                            <div>
                                <span class="text-xs text-gray-500">å‰©é¤˜</span>
                                <p class="font-bold ${remainingLeaveHours < 0 ? 'text-red-600' : 'text-green-600'}">${remainingLeaveHours.toFixed(1)}</p>
                            </div>
                        </div>
                        ${isOverLimit ? `<p class="text-red-600 text-xs mt-2 text-center font-semibold">âš ï¸ å·²è¶…éè«‹å‡æ™‚æ•¸ä¸Šé™ï¼</p>` : ''}
                    </div>
                `);
            });

            if (hasLeave) {
                leaveMessageEl.innerHTML = messages.join('');
                leaveInfoPanelEl.classList.remove('hidden');
            } else {
                leaveInfoPanelEl.classList.add('hidden');
            }
        }


        function parseTime(timeStr) {
            return timeStr.split(',').map(interval => {
                const [start, end] = interval.trim().split('~').map(t => {
                    const [h, m] = t.split(':').map(Number);
                    return h * 60 + m;
                });
                return { start, end };
            });
        }

        function checkForConflicts() {
            const selectedCourseObjects = Array.from(selectedCourses).map(id => courses.find(c => c.id === id));
            const dailySchedule = {};
            let conflictFound = false;
            let conflictDetails = '';

            selectedCourseObjects.forEach(course => {
                const timeIntervals = parseTime(course.time);
                Object.keys(classSchedule).forEach(dateString => {
                    if (classSchedule[dateString].some(c => c.id === course.id)) {
                        if (!dailySchedule[dateString]) dailySchedule[dateString] = [];
                        timeIntervals.forEach(interval => {
                            dailySchedule[dateString].push({ ...interval, courseName: course.name });
                        });
                    }
                });
            });

            for (const date in dailySchedule) {
                const dayEvents = dailySchedule[date].sort((a, b) => a.start - b.start);
                if (dayEvents.length < 2) continue;
                for (let i = 0; i < dayEvents.length - 1; i++) {
                    if (dayEvents[i].end > dayEvents[i+1].start) {
                        conflictFound = true;
                        const conflictDate = new Date(date).toLocaleDateString('zh-Hant');
                        conflictDetails = `æ–¼ ${conflictDate}ï¼Œèª²ç¨‹ "${dayEvents[i].courseName.split('ç¬¬')[0]}" èˆ‡ "${dayEvents[i+1].courseName.split('ç¬¬')[0]}" æ™‚é–“é‡ç–Šã€‚`;
                        break;
                    }
                }
                if (conflictFound) break;
            }

            conflictMessageEl.textContent = conflictDetails;
            conflictWarningEl.classList.toggle('hidden', !conflictFound);
        }

        // --- MODIFIED: åœ¨èª²ç¨‹è©³ç´°è³‡è¨Šä¸­é¡¯ç¤ºæ›´è©³ç´°çš„è«‹å‡è³‡è¨Š ---
        function showInfoPanel(dateString, dayElement) {
            if (lastSelectedDay) lastSelectedDay.classList.remove('day-selected');
            dayElement.classList.add('day-selected');
            lastSelectedDay = dayElement;

            const classes = classSchedule[dateString];
            const date = new Date(dateString);
            const formattedDate = date.toLocaleDateString('zh-Hant', { year: 'numeric', month: 'long', day: 'numeric' });
            
            let contentHTML = `<p class="text-gray-600 mb-4">æ—¥æœŸï¼š${formattedDate}</p>`;
            classes.forEach(course => {
                const isLeave = getLeaveDatesForCourse(course.id).includes(dateString);
                let leaveInfoHTML = '';

                if (isLeave) {
                    const sessionHours = calculateSessionHours(course.time);
                    const courseLeaveDates = leaveData[course.id] || [];
                    const totalLeaveHours = courseLeaveDates.length * sessionHours;
                    const maxLeaveHours = course.hours / 5;
                    const remainingLeaveHours = maxLeaveHours - totalLeaveHours;

                    leaveInfoHTML = `
                        <div class="mt-3 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-3 rounded-md text-sm">
                            <p class="font-bold mb-2 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                                è«‹å‡æ™‚æ•¸èªªæ˜
                            </p>
                            <div class="grid grid-cols-2 gap-x-4 gap-y-1 mt-2">
                                <span>æ™‚æ•¸ä¸Šé™:</span> <span class="font-semibold text-blue-700">${maxLeaveHours.toFixed(1)} å°æ™‚</span>
                                <span>æœ¬æ¬¡è«‹å‡:</span> <span class="font-semibold">${sessionHours.toFixed(1)} å°æ™‚</span>
                                <span>ç´¯è¨ˆè«‹å‡:</span> <span class="font-semibold ${totalLeaveHours > maxLeaveHours ? 'text-red-600' : ''}">${totalLeaveHours.toFixed(1)} å°æ™‚</span>
                                <span>å‰©é¤˜æ™‚æ•¸:</span> <span class="font-bold ${remainingLeaveHours < 0 ? 'text-red-600' : 'text-green-700'}">${remainingLeaveHours.toFixed(1)} å°æ™‚</span>
                            </div>
                        </div>
                    `;
                }
                
                contentHTML += `
                    <div class="border-l-4 p-4 rounded-r-lg mb-3" style="border-color: ${course.color}; background-color: ${course.color}1A;">
                        <p class="font-bold text-gray-900 flex items-center">
                          ${course.name}
                          ${isLeave ? '<span class="ml-2 bg-yellow-200 text-yellow-800 text-xs font-medium px-2.5 py-0.5 rounded-full">å·²è«‹å‡</span>' : ''}
                        </p>
                        <div class="mt-2 text-sm text-gray-700 space-y-1">
                            <p><strong class="font-semibold">ä¸Šèª²æ™‚é–“ï¼š</strong>${course.time}</p>
                            <p><strong class="font-semibold">æˆèª²è€å¸«ï¼š</strong>${course.teacher}</p>
                            <p><strong class="font-semibold">ä¸Šèª²åœ°å€ï¼š</strong>${course.address}</p>
                        </div>
                        ${leaveInfoHTML}
                    </div>
                `;
            });
            infoPanelContent.innerHTML = contentHTML;
            infoPanel.classList.remove('hidden');
            setTimeout(() => {
                infoPanel.classList.remove('opacity-0', '-translate-y-4');
                infoPanel.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 10);
        }

        function hideInfoPanel() {
            if (lastSelectedDay) {
                lastSelectedDay.classList.remove('day-selected');
                lastSelectedDay = null;
            }
            infoPanel.classList.add('opacity-0', '-translate-y-4');
            setTimeout(() => infoPanel.classList.add('hidden'), 300);
        }

        function openModal() {
            modalOverlay.classList.remove('hidden');
            setTimeout(() => {
                 modalOverlay.classList.remove('opacity-0');
                 modalOverlay.querySelector('.modal-content').classList.remove('scale-95');
            }, 10);
        }

        function closeModal() {
            modalOverlay.classList.add('opacity-0');
            modalOverlay.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => modalOverlay.classList.add('hidden'), 300);
        }

        async function fetchWithRetry(url, options, maxRetries = 5, initialDelay = 1000) {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return response;
                    if (response.status >= 400 && response.status < 500 && response.status !== 429) {
                        throw new Error(`API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼ï¼š${response.status}`);
                    }
                } catch (error) {
                    if (attempt === maxRetries - 1) throw error;
                }
                await new Promise(resolve => setTimeout(resolve, initialDelay * Math.pow(2, attempt)));
            }
            throw new Error('API è«‹æ±‚é‡è©¦å¤šæ¬¡å¾Œä»ç„¶å¤±æ•—ã€‚');
        }

        async function handleGetRecommendation() {
            openModal();
            loader.classList.remove('hidden');
            aiResponse.classList.add('hidden');
            aiResponse.innerHTML = '';

            const selectedCourseDetails = Array.from(selectedCourses).map(id => courses.find(c => c.id === id));
            const prompt = `æ‚¨æ˜¯ä¸€ä½å°ˆæ¥­çš„è·æ¶¯ç™¼å±•èˆ‡å­¸ç¿’é¡§å•ã€‚è«‹æ ¹æ“šä½¿ç”¨è€…é¸æ“‡çš„ä»¥ä¸‹èª²ç¨‹ï¼Œç‚ºä»–å€‘æä¾›ä¸€ä»½ç¶œåˆçš„å­¸ç¿’è·¯å¾‘å»ºè­°ã€‚

é¸æ“‡çš„èª²ç¨‹åˆ—è¡¨ï¼š
${selectedCourseDetails.map(c => `- **${c.name}**: æˆèª²è€å¸«ç‚º ${c.teacher}ï¼Œç¸½æ™‚æ•¸ ${c.hours} å°æ™‚ã€‚`).join('\n')}

æ‚¨çš„å»ºè­°æ‡‰åŒ…å«ä»¥ä¸‹å¹¾é»ï¼Œä¸¦ä½¿ç”¨ Markdown æ ¼å¼åŒ–ï¼Œå„é»ä½¿ç”¨ ### ä½œç‚ºä¸‰ç´šæ¨™é¡Œï¼š
1. ### ç¶œæ•ˆåˆ†æï¼šåˆ†æé€™äº›èª²ç¨‹çš„çŸ¥è­˜é»å¦‚ä½•ç›¸è¼”ç›¸æˆã€‚
2. ### å­¸ç¿’é †åºå»ºè­°ï¼šå»ºè­°ä¸€å€‹ç†æƒ³çš„å­¸ç¿’é †åºä¸¦è§£é‡‹åŸå› ã€‚
3. ### è·æ¶¯ç™¼å±•æ½›åŠ›ï¼šèªªæ˜å®Œæˆèª²ç¨‹å¾Œçš„å¯èƒ½è·æ¥­æ–¹å‘ã€‚
4. ### å»¶ä¼¸å­¸ç¿’å»ºè­°ï¼šæ¨è–¦å…¶ä»–ç›¸é—œè³‡æºä»¥æ·±åŒ–å­¸ç¿’ã€‚

è«‹ä»¥æ¢ç†åˆ†æ˜ã€å°ˆæ¥­ä¸”é¼“å‹µäººå¿ƒçš„èªæ°£å‘ˆç¾ã€‚`;

            try {
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || 'ç„¡æ³•ç²å–å»ºè­°ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
                
                let html = text
                    .replace(/^### (.*$)/gm, '<h3 class="text-lg sm:text-xl font-bold mt-6 mb-3 text-gray-800 border-b pb-2">$1</h3>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold text-gray-900">$1</strong>')
                    .replace(/^(?:\s*[-*]\s.*(?:\n|$))+/gm, (match) => `<ul class="list-disc pl-5 text-gray-700 space-y-2">${match.trim().split('\n').map(item => `<li>${item.replace(/^\s*[-*]\s/, '')}</li>`).join('')}</ul>`)
                    .replace(/^(?:\s*\d+\.\s.*(?:\n|$))+/gm, (match) => `<ol class="list-decimal pl-5 text-gray-700 space-y-2">${match.trim().split('\n').map(item => `<li>${item.replace(/^\s*\d+\.\s/, '')}</li>`).join('')}</ol>`)
                    .replace(/\n/g, '<br>')
                    .replace(/<br>\s*<(h3|ul|ol)/g, '<$1')
                    .replace(/<\/(h3|ul|ol)>\s*<br>/g, '</$1>');

                aiResponse.innerHTML = html;

            } catch (error) {
                console.error("Gemini API Error:", error);
                aiResponse.innerHTML = `<p class="text-red-500">ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}</p><p>è«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šï¼Œæˆ–ç¨å¾Œå†è©¦ã€‚</p>`;
            } finally {
                loader.classList.add('hidden');
                aiResponse.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>

